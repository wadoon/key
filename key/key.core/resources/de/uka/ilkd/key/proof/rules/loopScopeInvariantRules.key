\schemaVariables {
    \modalOperator { diamond, box } #allmodal;
	\modalOperator { diamond_transaction, box_transaction } #transmodal;
    \formula #post;
	\formula #ts;
	\formula #inv;
    \program Statement #body;
    \program Expression #nse;
    \program Variable #x, #heapBeforeLoop;
    \program LoopInit #loopInit;
    \program Guard #guard;
    \program ForUpdates #forupdates; 
    \skolemTerm Heap #anonHeap;
}

\rules(programRules:Java) {
    loopScopeInvariantTacletWhile { 
        \find (
            (\modality{#allmodal} {.. while (#nse) #body ...} \endmodality(#post))
        )
          
        \varcond(
		    \new(#x, boolean), 
		    \new(#heapBeforeLoop, Heap), 
		    \getInvariant(#inv, #allmodal), 
		    \terminationSensitive(#ts, #allmodal))
    
        "Invariant Initially Valid":
        \replacewith(#inv);
    
        "Invariant Preserved and Used":
        \replacewith
        (
			{#anonUpdateTransformer(FALSE, #heapBeforeLoop, #anonHeap, #ts)}
            (#inv & #wellFormedAnonHeap(FALSE, #anonHeap) ->
                (\modality{#allmodal} { ..
                    boolean #x; #x = true;
                    loop-scope(#x) {
                        if (#nse) 
                        { #body #x = false; }
                    } ... 
				}\endmodality(((	
					(#x = TRUE) -> #post) & 
					((#x = FALSE) -> 
						#inv
                        & #getFrameCondition(FALSE, #heapBeforeLoop)
                        & #getVariant(TRUE))))
                )
            )
        )
    
        \heuristics(loop_inv_taclets)
    };
	
	loopScopeInvariantTacletWhileTransactional { 
        \find (
            (\modality{#transmodal} {.. while (#nse) #body ...} \endmodality(#post))
        )
          
        \varcond(
		    \new(#x, boolean), 
		    \new(#heapBeforeLoop, Heap), 
		    \getInvariant(#inv, #transmodal), 
		    \terminationSensitive(#ts, #transmodal))
    
        "Invariant Initially Valid":
        \replacewith(#inv);
    
        "Invariant Preserved and Used":
        \replacewith
        (
			{#anonUpdateTransformer(TRUE, #heapBeforeLoop, #anonHeap, #ts)}
            (#inv & #wellFormedAnonHeap(TRUE, #anonHeap) ->
                (\modality{#transmodal} { ..
                    boolean #x; #x = true;
                    loop-scope(#x) {
                        if (#nse) 
                        { #body #x = false; }
                    } ... 
				}\endmodality(((	
					(#x = TRUE) -> #post) & 
					((#x = FALSE) -> 
						#inv
                        & #getFrameCondition(TRUE, #heapBeforeLoop)
                        & #getVariant(TRUE))))
                )
            )
        )
    
        \heuristics(loop_inv_taclets)
    };
    
    loopScopeInvariantTacletFor { 
        \find (
            (\modality{#allmodal} {.. for(; #guard; #forupdates) #body ... }\endmodality(#post))
        )
        
		\varcond(
		    \new(#x, boolean), 
		    \new(#heapBeforeLoop, Heap), 
		    \getInvariant(#inv, #allmodal), 
		    \getGuardExpr(#nse, #guard), 
		    \terminationSensitive(#ts, #allmodal))
        
        "Invariant Initially Valid":
        \replacewith(#inv);
        
        "Invariant Preserved and Used":
        \replacewith
        (
            {#anonUpdateTransformer(FALSE, #heapBeforeLoop, #anonHeap, #ts)}
            (#inv & #wellFormedAnonHeap(FALSE, #anonHeap) ->
                (\modality{#allmodal} {.. 
					boolean #x; #x = true;
                    loop-scope(#x) {
                        if (#nse) {
                            #body 
                            #x = false; 
                        }
                        if (!#x) {
                            #x = true;
                            #forUpdateUnfoldTransformer(#forupdates);
                            #x = false;
                        }
                    } ...
                }\endmodality(((
					(#x = TRUE) -> #post) & 
                    ((#x = FALSE) -> 
						#inv
						& #getFrameCondition(FALSE, #heapBeforeLoop)
						& #getVariant(TRUE))))
                )
            )
        )
    
        \heuristics(loop_inv_taclets) 
    };
	
	loopScopeInvariantTacletForTransactional { 
        \find (
            (\modality{#transmodal} {.. for(; #guard; #forupdates) #body ... }\endmodality(#post))
        )
        
        \varcond(
		    \new(#x, boolean), 
		    \new(#heapBeforeLoop, Heap), 
		    \getInvariant(#inv, #transmodal), 
		    \getGuardExpr(#nse, #guard), 
		    \terminationSensitive(#ts, #transmodal))
        
        "Invariant Initially Valid":
        \replacewith(#inv);
        
        "Invariant Preserved and Used":
        \replacewith
        (
            {#anonUpdateTransformer(TRUE, #heapBeforeLoop, #anonHeap, #ts)}
            (#inv & #wellFormedAnonHeap(TRUE, #anonHeap) ->
                (\modality{#transmodal} {.. 
					boolean #x; #x = true;
                    loop-scope(#x) {
                        if (#nse) {
                            #body 
                            #x = false; 
                        }
                        if (!#x) {
                            #x = true;
                            #forUpdateUnfoldTransformer(#forupdates);
                            #x = false;
                        }
                    } ...
                }\endmodality(((
					(#x = TRUE) -> #post) & 
                    ((#x = FALSE) -> 
						#inv
						& #getFrameCondition(TRUE, #heapBeforeLoop)
						& #getVariant(TRUE))))
                )
            )
        )
    
        \heuristics(loop_inv_taclets) 
    };
}