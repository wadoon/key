\profile "Solidity";

\javaSource "casino-withdraw/";


\programVariables {
  OneAuction self;
  Message msg;
}
 
\rules {
  
 insertCInv {
    \schemaVar \term Heap h;
    \schemaVar \term OneAuction self;
    \schemaVar \variable Address a;
    \find(CInv(h, self))
    \varcond(\notFreeIn(a, h, self))
    \replacewith(    
// line 31-32
       Address::select(h, self, OneAuction::$owner) != self &
       Address::select(h, self, OneAuction::$bidder) != self 
&             
//line 51
      int::select(h, self, OneAuction::$value) = 
      int::select(h, net, address(
            Address::select(h, self, OneAuction::$bidder))) 
        - int::select(h, 
             int[]::select(h,self,OneAuction::$withdrawableBalances),                 
             arr((int)Address::select(h, self, OneAuction::$bidder)))      
      + 
      int::select(h, net, address(
        Address::select(h, self, OneAuction::$owner)
      )) - int::select(h, 
              int[]::select(h,self,OneAuction::$withdrawableBalances),                 
              arr((int)Address::select(h, self, OneAuction::$owner)))  
      &
// line 52-54:
 (\forall  a;(  
     (a != Address::select(h, self, OneAuction::$owner) & 
      a != Address::select(h, self, OneAuction::$bidder) &
      a != self) -> 
      int::select(h, net, address(a)) - int::select(h, 
             int[]::select(h,self,OneAuction::$withdrawableBalances),                 
             arr((int)a)) 
       = 0) 
)  &    
// line 55:  
    int::select(h, net, 
       address( Address::select(h, self, OneAuction::$owner)))
    - int::select(h, 
             int[]::select(h,self,OneAuction::$withdrawableBalances),                 
             arr((int)Address::select(h, self, OneAuction::$owner))) 
     <= 0   
& 
//line 56:
  (OneAuction.AuctionMode::select(h,null,OneAuction.AuctionMode::$Open) = 
     OneAuction.AuctionMode::select(h, self, OneAuction::$mode) ->
      int::select(h, net, address(Address::select(h, self, OneAuction::$owner))) = 
      int::select(h, 
             int[]::select(h,self,OneAuction::$withdrawableBalances),                 
             arr((int)Address::select(h, self, OneAuction::$owner))) 
      )  
 )
    \heuristics(userTaclets1)
  };

 }
 
\problem {
self.bidder != null   & 
self.owner != null &
msg.sender != self    &
msg.value = 0 & CInv(heap, self) 
->
{savedHeap:=heap || heap:=store(heap, net, address(msg.sender), int::select(heap, net, address(msg.sender)) + msg.value)}
 \[{ 
    self.withdraw(msg)@OneAuction;
}\] ( CInv(heap, self)       
     /* not provable due to call to transfer &   
      self.withdrawableBalances[(int)msg.sender] = 0
     */
     )


}
