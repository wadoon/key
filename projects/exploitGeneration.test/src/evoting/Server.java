package evoting;

public class Server {
	//public int[] votesForCandidates;
	public Result result;
	public int numberOfCandidates;
	private Voter[] voters;
	/*! result | voters ; !*/

	public void onCollectBallot(Message message){
		int vote = message.getBallot();
		if((vote>=0) && (vote<numberOfCandidates))
			result.bulletin[vote]++;
	}
	
	public Server(){
		this(2);
	}
	
	public Server(int numberOfCandidates){
		this.numberOfCandidates= numberOfCandidates;
		this.result = new Result(numberOfCandidates);
	}
	
	/*@normal_behavior
	 @requires numberOfCandidates>0 && voters!=null && voters.length>0 && (\forall int i; i>=0 && i<voters.length; voters[i]!=null);
	 	@*/
	public void election(){
		result = new Result(numberOfCandidates);
		
		/*@loop_invariant 
       i>=0 && 
       i<= voters.length && 
       (\forall int k; k>=0 && k< numberOfCandidates; 
         result.bulletin[k] == (\sum int j; 0 <= j && j < i; (k==voters[j].vote ? 1 : 0)))  ; 
      @assignable result.bulletin[*],i;
      @decreases voters.length-i;
      @*/
		for(int i=0; i < voters.length; i++)
			voters[i].onSendBallot(this);		
		//clearInfo();
	}
	
	private Result publishResult(){
		return result;
	}
	
	/*@requires true;@*/
	private void clearInfo(){
		voters = null;	
	}
}


/****@escapes (\seq_def int i; 0; numberOfCandidates;
	(\num_of int j; 0 <= j && j < voters.length; i==voters[j].vote));*/